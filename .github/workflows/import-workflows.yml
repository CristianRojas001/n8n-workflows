name: Deploy n8n Workflows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      N8N_API_URL:             ${{ secrets.N8N_API_URL }}
      N8N_BASIC_AUTH_USER:     ${{ secrets.N8N_BASIC_AUTH_USER }}
      N8N_BASIC_AUTH_PASSWORD: ${{ secrets.N8N_BASIC_AUTH_PASSWORD }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install n8n CLI (v1.84.3)
        run: npm install -g n8n@1.84.3

      - name: Check n8n API health
        run: |
          echo "üîó Pinging n8n at $N8N_API_URL/"
          HTTP_STATUS=$(
            curl -u "$N8N_BASIC_AUTH_USER:$N8N_BASIC_AUTH_PASSWORD" \
                 -s -o /dev/null -w "%{http_code}" \
                 "$N8N_API_URL/"
          )
          echo "‚Äì HTTP status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "‚ùå n8n returned HTTP $HTTP_STATUS" >&2
            exit 1
          fi

      - name: Lint workflows JSON
        run: |
          echo "üîç Validating workflows.ndjson"
          jq -s . workflows.ndjson > /dev/null

      - name: Debug & test import via HTTP API
        run: |
          AUTH="$N8N_BASIC_AUTH_USER:$N8N_BASIC_AUTH_PASSWORD"

          echo "üîç 1) Checking workflows.ndjson file"
          ls -l workflows.ndjson || { echo "‚ùå workflows.ndjson not found"; exit 1; }
          head -n3 workflows.ndjson
          echo

          echo "üîç 2) Testing which list endpoint works"
          for ep in "/api/v1/workflows" "/rest/workflows"; do
            STATUS=$(
              curl -u "$AUTH" -s -o /dev/null -w "%{http_code}" \
                   "$N8N_API_URL$ep"
            )
            echo "   GET $ep ‚Üí HTTP $STATUS"
          done
          echo

          echo "üîç 3) Attempting to import the _first_ workflow via each path"
          FIRST_WF=$(head -n1 workflows.ndjson)

          echo "   ‚Üí POST /api/v1/workflows"
          RESPONSE=$(
            curl -u "$AUTH" -s -w "\n%{http_code}" \
                 -H "Content-Type: application/json" \
                 -X POST "$N8N_API_URL/api/v1/workflows" \
                 -d "$FIRST_WF"
          )
          echo "$RESPONSE"
          echo

          echo "   ‚Üí POST /rest/workflows"
          RESPONSE2=$(
            curl -u "$AUTH" -s -w "\n%{http_code}" \
                 -H "Content-Type: application/json" \
                 -X POST "$N8N_API_URL/rest/workflows" \
                 -d "$FIRST_WF"
          )
          echo "$RESPONSE2"
