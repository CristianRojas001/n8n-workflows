name: Deploy n8n Workflows
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  import:
    runs-on: ubuntu-latest
    env:
      N8N_API_URL: https://e49b-85-53-80-220.ngrok-free.app
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install n8n CLI v1.84.3
        run: npm install -g n8n@1.84.3
      - name: Health-check n8n API
        run: |
          status=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "ngrok-skip-browser-warning: true" \
            -o /dev/null -w "%{http_code}" \
            "$N8N_API_URL/api/v1/workflows")
          if [ "$status" -ne 200 ]; then
            echo "‚ùå n8n API unhealthy (HTTP $status)" >&2
            exit 1
          fi
          echo "‚úÖ n8n API healthy (HTTP $status)"
      - name: Import workflows via HTTP API
        run: |
          echo "üöÄ Importing workflows from workflows.ndjson"
          
          # Simple import without complex error handling
          cat workflows.ndjson | while read -r workflow_json; do
            if [ -n "$workflow_json" ]; then
              name=$(echo "$workflow_json" | jq -r '.name // "unnamed"')
              echo "üëâ Importing: $name"
              
              echo "$workflow_json" | curl -s \
                -H "Content-Type: application/json" \
                -H "X-N8N-API-KEY: $N8N_API_KEY" \
                -H "ngrok-skip-browser-warning: true" \
                -X POST "$N8N_API_URL/api/v1/workflows" \
                -d @- \
                && echo "   ‚úÖ Imported successfully" \
                || echo "   ‚ùå Import failed"
            fi
          done
      - name: Verify import via HTTP API
        run: |
          response=$(curl -s \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "ngrok-skip-browser-warning: true" \
            "$N8N_API_URL/api/v1/workflows")
          count=$(echo "$response" | jq '.data | length')
          echo "üìÑ Total workflows in n8n: $count"
