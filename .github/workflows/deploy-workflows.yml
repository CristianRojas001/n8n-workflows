name: Deploy n8n Workflows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  import:
    runs-on: ubuntu-latest
    env:
      N8N_API_URL: https://e49b-85-53-80-220.ngrok-free.app
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install n8n CLI v1.84.3
        run: npm install -g n8n@1.84.3

      - name: Health-check n8n API
        run: |
          status=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -o /dev/null -w "%{http_code}" \
            "$N8N_API_URL/rest/workflows")
          if [ "$status" -ne 200 ]; then
            echo "❌ n8n API unhealthy (HTTP $status)" >&2
            exit 1
          fi

      - name: Import workflows via HTTP API
        run: |
          echo "🚀 Importing workflows.ndjson into $N8N_API_URL/rest/workflows"
          while IFS= read -r wf; do
            name=$(echo "$wf" | jq -r .name)
            echo "👉 $name"
            status=$(echo "$wf" | \
              curl -s -o /dev/null -w "%{http_code}" \
                   -H "Content-Type: application/json" \
                   -H "X-N8N-API-KEY: $N8N_API_KEY" \
                   -X POST "$N8N_API_URL/rest/workflows" \
                   --data-binary @-)
            echo "   ↳ HTTP status: $status"
            if [ "$status" -ne 200 ]; then
              echo "❌ Failed importing '$name' (HTTP $status)" >&2
              exit 1
            fi
          done < workflows.ndjson

      - name: Verify import via HTTP API
        run: |
          count=$(curl -s \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            "$N8N_API_URL/rest/workflows" | jq '. | length')
          echo "📄 Workflows count: $count"
