name: Deploy n8n Workflows
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  import:
    runs-on: ubuntu-latest
    env:
      N8N_API_URL: https://e49b-85-53-80-220.ngrok-free.app
      N8N_API_KEY: ${{ secrets.N8N_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install n8n CLI v1.84.3
        run: npm install -g n8n@1.84.3
      - name: Health-check n8n API
        run: |
          status=$(curl -s \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "ngrok-skip-browser-warning: true" \
            -o /dev/null -w "%{http_code}" \
            "$N8N_API_URL/api/v1/workflows")
          if [ "$status" -ne 200 ]; then
            echo "‚ùå n8n API unhealthy (HTTP $status)" >&2
            exit 1
          fi
          echo "‚úÖ n8n API healthy (HTTP $status)"
      - name: Import workflows via HTTP API
        run: |
          echo "üöÄ Importing workflows from workflows.ndjson"
          
          # Check if workflows.ndjson exists
          if [ ! -f workflows.ndjson ]; then
            echo "‚ùå workflows.ndjson file not found"
            exit 1
          fi
          
          # Count total workflows
          total_workflows=$(wc -l < workflows.ndjson)
          echo "üìÑ Found $total_workflows workflows to import"
          
          # Process each workflow
          line_num=0
          while IFS= read -r workflow_json; do
            line_num=$((line_num + 1))
            
            # Skip empty lines
            if [ -z "$workflow_json" ]; then
              continue
            fi
            
            # Validate JSON and extract name
            if ! echo "$workflow_json" | jq . > /dev/null 2>&1; then
              echo "‚ö†Ô∏è  Line $line_num: Invalid JSON, skipping"
              continue
            fi
            
            name=$(echo "$workflow_json" | jq -r '.name // "unnamed"')
            echo "üëâ [$line_num/$total_workflows] Importing: $name"
            
            # Import the workflow
            response=$(echo "$workflow_json" | curl -s -w "\n%{http_code}" \
              -H "Content-Type: application/json" \
              -H "X-N8N-API-KEY: $N8N_API_KEY" \
              -H "ngrok-skip-browser-warning: true" \
              -X POST "$N8N_API_URL/api/v1/workflows" \
              -d @-)
            
            # Extract HTTP status code from response
            http_code=$(echo "$response" | tail -n1)
            response_body=$(echo "$response" | head -n -1)
            
            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "   ‚úÖ Imported successfully (HTTP $http_code)"
            else
              echo "   ‚ùå Import failed (HTTP $http_code)"
              echo "   Response: $response_body"
            fi
          done < workflows.ndjson
      - name: Verify import via HTTP API
        run: |
          response=$(curl -s \
            -H "Accept: application/json" \
            -H "X-N8N-API-KEY: $N8N_API_KEY" \
            -H "ngrok-skip-browser-warning: true" \
            "$N8N_API_URL/api/v1/workflows")
          count=$(echo "$response" | jq '.data | length')
          echo "üìÑ Total workflows in n8n: $count"
